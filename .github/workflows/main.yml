name: Monstro V18 - Estabilidade Total (Motor Fixo)

on:
  push:
    branches: [ "principal", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Preparar Estrutura Industrial
      run: |
        echo "### LIMPANDO AMBIENTE ###"
        rm -rf .gradle build app/build
        
        # Garante as permissões do motor
        chmod +x gradlew
        
        # O motor agora apenas valida se os arquivos que você criou estão lá
        if [ ! -f "app/src/main/AndroidManifest.xml" ]; then
          echo "✖ ERRO: Estrutura física não encontrada!"
          exit 1
        fi

    - name: Fabricar APK (Modo Industrial)
      # Aqui o motor segue firme usando o seu gradle.properties real
      run: ./gradlew :app:assembleDebug --no-daemon --stacktrace

    - name: Coleta e Entrega
      run: |
        mkdir -p pacotes_entrega
        # Busca o APK gerado na estrutura profissional
        find app/build/outputs/apk/debug/ -name "*.apk" -exec cp {} pacotes_entrega/ \;
        if [ -z "$(ls -A pacotes_entrega)" ]; then
          echo "✖ ERRO: O compilador falhou antes de gerar o arquivo."
          exit 1
        fi

    - name: Upload Monstro
      uses: actions/upload-artifact@v4
      with:
        name: MonstroV18-FINAL
        path: pacotes_entrega/*.apk
