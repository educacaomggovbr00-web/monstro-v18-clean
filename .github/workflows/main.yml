name: Monstro V18 - Destravando o Build

on:
  push:
    branches: [ "principal", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Preparar Estrutura e Localizar KT
      run: |
        rm -rf .gradle build app/build
        echo "org.gradle.jvmargs=-Xmx2g -XX:MaxMetaspaceSize=1g" > gradle.properties
        echo "include ':app'" > settings.gradle
        mkdir -p app/src/main/java/com/monstro/v18
        
        # Busca seu código original e injeta na pasta certa
        find . -name "MainActivity.kt" -exec cp {} app/src/main/java/com/monstro/v18/MainActivity.kt \;

    - name: Injetar Receitas Industriais
      run: |
        # Build.gradle raiz e do app sincronizados
        cat <<EOF > build.gradle
        buildscript {
            repositories { google(); mavenCentral() }
            dependencies { 
                classpath 'com.android.tools.build:gradle:8.2.2'
                classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.22'
            }
        }
        allprojects { repositories { google(); mavenCentral() } }
        EOF

        cat <<EOF > app/build.gradle
        plugins { id 'com.android.application'; id 'org.jetbrains.kotlin.android' }
        android {
            namespace 'com.monstro.v18'
            compileSdk 34
            defaultConfig { applicationId "com.monstro.v18"; minSdk 24; targetSdk 34; versionCode 18; versionName "18.0" }
            buildFeatures { compose true }; composeOptions { kotlinCompilerExtensionVersion '1.5.8' }
            compileOptions { sourceCompatibility JavaVersion.VERSION_17; targetCompatibility JavaVersion.VERSION_17 }
            kotlinOptions { jvmTarget = '17' }
        }
        dependencies {
            implementation 'androidx.core:core-ktx:1.12.0'
            implementation 'androidx.activity:activity-compose:1.8.2'
            implementation platform('androidx.compose:compose-bom:2024.02.00')
            implementation 'androidx.compose.ui:ui'; implementation 'androidx.compose.material3:material3'
            implementation 'androidx.media3:media3-exoplayer:1.2.1'; implementation 'androidx.media3:media3-ui:1.2.1'
        }
        EOF

        echo '<manifest xmlns:android="http://schemas.android.com/apk/res/android"><application android:label="Monstro V18"><activity android:name="com.monstro.v18.MainActivity" android:exported="true"><intent-filter><action android:name="android.intent.action.MAIN" /><category android:name="android.intent.category.LAUNCHER" /></intent-filter></activity></application></manifest>' > app/src/main/AndroidManifest.xml
        
        gradle wrapper --gradle-version 8.4
        chmod +x gradlew

    - name: Fabricar APK (Com Auto-Retry)
      # Tenta até 3 vezes para vencer o 'Tigrinho' do cache
      run: |
        n=0
        until [ $n -ge 3 ]; do
           ./gradlew clean :app:assembleDebug --no-daemon --stacktrace && break
           n=$[$n+1]
           echo "Falha na tentativa $n... limpando e tentando de novo."
           rm -rf .gradle
           sleep 5
        done

    - name: Entregar APK Monstro
      uses: actions/upload-artifact@v4
      with:
        name: MonstroV18-FINAL
        path: app/build/outputs/apk/debug/*.apk
