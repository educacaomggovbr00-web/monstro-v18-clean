name: Monstro V18 - Limpeza e Build

on:
  push:
    branches: [ "principal", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Blindagem de Memoria
      run: |
        echo "### APLICANDO CONFIGS REAIS ###"
        # Suas configurações que evitam o engasgo do Daemon
        echo "org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g -Dfile.encoding=UTF-8" > gradle.properties
        echo "org.gradle.workers.max=2" >> gradle.properties
        echo "org.gradle.daemon=false" >> gradle.properties
        
        # Mapa de pastas
        echo "include ':app'" > settings.gradle
        mkdir -p app
        if [ -f build.gradle ]; then cp build.gradle app/; fi

        # MainActivity Simples para garantir o APK agora
        mkdir -p app/src/main/java/com/monstro/v18
        cat <<'EOF' > app/src/main/java/com/monstro/v18/MainActivity.kt
        package com.monstro.v18
        import android.os.Bundle
        import androidx.activity.ComponentActivity
        import androidx.activity.compose.setContent
        import androidx.compose.material3.Text
        class MainActivity : ComponentActivity() {
            override fun onCreate(savedInstanceState: Bundle?) {
                super.onCreate(savedInstanceState)
                setContent { Text("MONSTRO V18 - PRONTO") }
            }
        }
        EOF

    - name: Compilar (Forca Bruta Sem Daemon)
      run: |
        gradle wrapper --gradle-version 8.4
        chmod +x gradlew
        # A sequência correta: clean primeiro, depois assemble
        ./gradlew clean --no-daemon
        ./gradlew :app:assembleDebug --no-daemon --stacktrace

    - name: Entregar APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: MonstroV18-FINAL
        path: app/build/outputs/apk/debug/*.apk
