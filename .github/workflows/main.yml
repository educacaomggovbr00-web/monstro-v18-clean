name: Monstro V18 - Dois Pendrives (Otimizado)

on:
  push:
    branches: [ "principal", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: üõ†Ô∏è Pendrive 1: Inje√ß√£o de Seguran√ßa
      run: |
        echo "### PREPARANDO MOTOR ###"
        # Limpeza focada sem destruir o ambiente
        rm -rf app/build pacotes_monstro
        
        # Garante as pastas
        mkdir -p app/src/main/java/com/monstro/v18
        
        # O 'Pendrive' busca seu c√≥digo real e injeta
        find . -name "MainActivity.kt" -exec cp {} app/src/main/java/com/monstro/v18/MainActivity.kt \;
        
        # Check inteligente do Wrapper (S√≥ recria se n√£o existir)
        [ -f gradlew ] || gradle wrapper --gradle-version 8.4
        chmod +x gradlew

    - name: ‚öôÔ∏è Processamento (Build Industrial)
      # Uso do clean para garantir que o APK seja 100% novo
      run: ./gradlew clean :app:assembleDebug --no-daemon --stacktrace

    - name: üöÄ Pendrive 2: Coleta Blindada
      run: |
        mkdir -p pacotes_monstro
        # Caminho direto para evitar sobrescrita de lixo
        if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          cp app/build/outputs/apk/debug/app-debug.apk pacotes_monstro/monstro_v18_final.apk
        else
          # Fallback de busca caso o nome mude
          find app/build/outputs/apk/ -name "*.apk" -exec cp {} pacotes_monstro/monstro_v18_final.apk \;
        fi
        
        # Valida√ß√£o de sa√≠da
        if [ ! -f "pacotes_monstro/monstro_v18_final.apk" ]; then
          echo "‚úñ ERRO CR√çTICO: APK N√ÉO GERADO"
          exit 1
        fi

    - name: Upload para o Henrique
      uses: actions/upload-artifact@v4
      with:
        name: MonstroV18-FINAL
        path: pacotes_monstro/*.apk
