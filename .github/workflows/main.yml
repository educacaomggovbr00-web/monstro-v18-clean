name: Monstro V18 - Build Real Misturado

on:
  push:
    branches: [ "principal", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Reset de Fabrica e Injecao do Pendrive
      run: |
        echo "### LIMPANDO RASTROS ###"
        rm -rf .gradle build app/build
        
        mkdir -p app/src/main/java/com/monstro/v18
        mkdir -p app/src/main/res/values

        # MISTURA: Copia seu arquivo real do repositorio
        find . -name "MainActivity.kt" -exec cp {} app/src/main/java/com/monstro/v18/MainActivity.kt \;

        # Injeta o Manifesto linha por linha (Blindado)
        echo '<manifest xmlns:android="http://schemas.android.com/apk/res/android">' > app/src/main/AndroidManifest.xml
        echo '    <application android:label="Monstro V18" android:theme="@android:style/Theme.DeviceDefault.NoActionBar">' >> app/src/main/AndroidManifest.xml
        echo '        <activity android:name="com.monstro.v18.MainActivity" android:exported="true">' >> app/src/main/AndroidManifest.xml
        echo '            <intent-filter>' >> app/src/main/AndroidManifest.xml
        echo '                <action android:name="android.intent.action.MAIN" />' >> app/src/main/AndroidManifest.xml
        echo '                <category android:name="android.intent.category.LAUNCHER" />' >> app/src/main/AndroidManifest.xml
        echo '            </intent-filter>' >> app/src/main/AndroidManifest.xml
        echo '        </activity>' >> app/src/main/AndroidManifest.xml
        echo '    </application>' >> app/src/main/AndroidManifest.xml
        echo '</manifest>' >> app/src/main/AndroidManifest.xml

        # Injeta configuracoes do Gradle linha por linha
        echo "include ':app'" > settings.gradle
        echo "org.gradle.jvmargs=-Xmx1536m -XX:MaxMetaspaceSize=512m" > gradle.properties
        echo "org.gradle.workers.max=1" >> gradle.properties
        echo "android.useAndroidX=true" >> gradle.properties
        echo "android.enableJetifier=true" >> gradle.properties
        
        # Cria o build.gradle da Raiz
        echo "buildscript { repositories { google(); mavenCentral() } dependencies { classpath 'com.android.tools.build:gradle:8.2.2'; classpath 'org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.22' } }" > build.gradle
        echo "allprojects { repositories { google(); mavenCentral() } }" >> build.gradle

        # Cria o app/build.gradle
        echo "plugins { id 'com.android.application'; id 'org.jetbrains.kotlin.android' }" > app/build.gradle
        echo "android { namespace 'com.monstro.v18'; compileSdk 34; defaultConfig { applicationId 'com.monstro.v18'; minSdk 24; targetSdk 34; versionCode 18; versionName '18.0' } }" >> app/build.gradle
        echo "android { buildFeatures { compose true }; composeOptions { kotlinCompilerExtensionVersion '1.5.8' } }" >> app/build.gradle
        echo "android { compileOptions { sourceCompatibility JavaVersion.VERSION_17; targetCompatibility JavaVersion.VERSION_17 }; kotlinOptions { jvmTarget = '17' } }" >> app/build.gradle
        echo "dependencies { implementation 'androidx.core:core-ktx:1.12.0'; implementation 'androidx.lifecycle:lifecycle-runtime-ktx:2.7.0'; implementation 'androidx.activity:activity-compose:1.8.2' }" >> app/build.gradle
        echo "dependencies { implementation platform('androidx.compose:compose-bom:2024.02.00'); implementation 'androidx.compose.ui:ui'; implementation 'androidx.compose.material3:material3' }" >> app/build.gradle
        echo "dependencies { implementation 'androidx.media3:media3-exoplayer:1.2.1'; implementation 'androidx.media3:media3-ui:1.2.1' }" >> app/build.gradle
        
        gradle wrapper --gradle-version 8.4
        chmod +x gradlew

    - name: Processamento (Build do Novo Sistema)
      run: ./gradlew clean :app:assembleDebug --no-daemon --stacktrace

    - name: Pendrive 2: Geracao e Entrega
      run: |
        mkdir -p pacotes_entrega
        # Varredura para encontrar o APK gerado
        find app/build/outputs/apk/ -name "*.apk" -exec cp {} pacotes_entrega/monstro_v18_final.apk \;
        if [ ! -f "pacotes_entrega/monstro_v18_final.apk" ]; then
          echo "ERRO: APK nao gerado!"
          exit 1
        fi

    - name: Upload Monstro V18
      uses: actions/upload-artifact@v4
      with:
        name: MonstroV18-FINAL
        path: pacotes_entrega/*.apk
